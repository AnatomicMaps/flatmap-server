Flatmap Server
==============

An anatomical flatmap server to provide `Mapbox <https://www.mapbox.com/>`_ compatible tilesets generated by `flatmap-maker <https://github.com/dbrnz/flatmap-maker>`_. It is intended for use with a browser-based `flatmap-viewer <https://github.com/ABI-Software/flatmap-viewer>`_ application. The server is written in Python using the `Flask <https://flask.palletsprojects.com/en/1.1.x/>`_ web framework.

Prerequisites
-------------

* Python 3.8
* `pipenv <https://pypi.org/project/pipenv/>`_

Under Ubuntu, for map making::

    # apt-get install libgl-mesa-glx


Installation
------------

1) Download the `latest release <https://github.com/dbrnz/flatmap-server/releases/latest>`_ and extract it to a suitable directory.
2) Change to this directory and run ``pipenv install``.


Running
-------

::

    $ pipenv run gunicorn src.server:app


* By default, maps are stored in ``./flatmaps``. This can be overridden by setting the ``FLATMAP_ROOT`` environment variable to a directory path.
* The server listens at ``http://localhost:8000``. Change this via `Gunicorn <https://docs.gunicorn.org/en/stable/settings.html>`_.


Optional map viewer
===================

As an option, the server provides a simple flatmap viewer application. Prerequisites are ``node`` and ``npm``. To install the viewer give the following commands from the top-level server directory::

    $ git clone https://github.com/dbrnz/flatmap-server-viewer viewer
    $ cd viewer
    $ npm install
    $ npm run build
    $ cd ..


Running
-------

To run the server with the integrated viewer::

    $ pipenv run gunicorn src.server:viewer

and open `<http://localhost:8000/viewer>`_ in a browser.

Map making
==========

The flatmap server can make maps using ``flatmap-maker``, provided `Tippecanoe <https://github.com/mapbox/tippecanoe#installation>`_ is installed.

To make a map, ``POST`` a request to the ``/make/map`` end-point specifying a directory containing a map's ``manifest.json``. The server will respond with the id of the maker process. The ``/make/status/PROCESS_ID`` end-point allows the process's status to be queried and ``/make/log/PROCESS_ID`` will return a log of a running process.

Examples
--------

A local map source::

    $ curl -H "Content-Type: application/json" -X POST \
           -d '{"source":"/Users/dave//build/Flatmaps/new-maker/tests/gradients"}'  \
           http://localhost:8000/make/map

    {"maker":18259,"source":"/Users/dave//build/Flatmaps/new-maker/tests/gradients","status":"started"}

::

    $ curl http://localhost:8000/make/status/18259

    {"maker":18259,"status":"terminated"}

::

    $ curl http://localhost:8000/make/log/18259

    2021-01-22 09:14:05,925 Mapmaker 1.0.0b1
    2021-01-22 09:14:05,928 Adding details...
    2021-01-22 09:14:05,928 Outputting GeoJson features...
    2021-01-22 09:14:05,928 Layer:gradients
    2021-01-22 09:14:05,929 Running tippecanoe...
    2021-01-22 09:14:06,020 Generating background tiles (may take a while...)
    2021-01-22 09:14:06,021 Tiling gradients_image...
    2021-01-22 09:14:06,040 Tiling zoom level 10 for gradients_image
    2021-01-22 09:14:08,811 Tiling zoom level 9 for gradients_image
    2021-01-22 09:14:08,935 Tiling zoom level 8 for gradients_image
    2021-01-22 09:14:08,976 Tiling zoom level 7 for gradients_image
    2021-01-22 09:14:08,994 Tiling zoom level 6 for gradients_image
    2021-01-22 09:14:09,005 Tiling zoom level 5 for gradients_image
    2021-01-22 09:14:09,015 Tiling zoom level 4 for gradients_image
    2021-01-22 09:14:09,024 Tiling zoom level 3 for gradients_image
    2021-01-22 09:14:09,034 Tiling zoom level 2 for gradients_image
    2021-01-22 09:14:09,063 Creating index and style files...
    2021-01-22 09:14:09,065 Generated map: gradients


A particular version of the rat flatmap held in PMR::

    $ curl -H "Content-Type: application/json" -X POST \
           -d '{"source":"https://models.physiomeproject.org/workspace/62f/rawfile/5a36c5db64705bdc9c4e11fb22760a57e79166e2"}'  \
           http://localhost:8000/make/map

    {"maker":17142,"source":"https://models.physiomeproject.org/workspace/62f/rawfile/5a36c5db64705bdc9c4e11fb22760a57e79166e2","status":"started"}

::

    $ curl http://localhost:8000/make/status/17142

    {"maker":17142,"status":"running"}

::

    $ curl http://localhost:8000/make/log/17142

    2021-01-22 08:57:11,424 Mapmaker 1.0.0b1
    2021-01-22 09:00:23,601 Adding details...
    2021-01-22 09:00:23,849 Outputting GeoJson features...
    2021-01-22 09:00:23,849 Layer:whole-rat
    2021-01-22 09:00:29,716 Layer:whole-rat_details
    2021-01-22 09:00:30,273 Running tippecanoe...
    2021-01-22 09:00:45,213 Generating background tiles (may take a while...)
    2021-01-22 09:00:45,234 Tiling whole-rat_image...
    2021-01-22 09:01:00,435 Tiling zoom level 10 for whole-rat_image

::

    $ curl http://localhost:8000/make/status/17142

    {"maker":17142,"status":"terminated"}

::

    $ curl http://localhost:8000/make/log/17142

    2021-01-22 08:57:11,424 Mapmaker 1.0.0b1
    2021-01-22 09:00:23,601 Adding details...
    2021-01-22 09:00:23,849 Outputting GeoJson features...
    2021-01-22 09:00:23,849 Layer:whole-rat
    2021-01-22 09:00:29,716 Layer:whole-rat_details
    2021-01-22 09:00:30,273 Running tippecanoe...
    2021-01-22 09:00:45,213 Generating background tiles (may take a while...)
    2021-01-22 09:00:45,234 Tiling whole-rat_image...
    2021-01-22 09:01:00,435 Tiling zoom level 10 for whole-rat_image
    2021-01-22 09:02:13,641 Tiling zoom level 9 for whole-rat_image
    2021-01-22 09:02:19,173 Tiling zoom level 8 for whole-rat_image
    2021-01-22 09:02:21,002 Tiling zoom level 7 for whole-rat_image
    2021-01-22 09:02:21,668 Tiling zoom level 6 for whole-rat_image
    2021-01-22 09:02:21,887 Tiling zoom level 5 for whole-rat_image
    2021-01-22 09:02:21,970 Tiling zoom level 4 for whole-rat_image
    2021-01-22 09:02:22,002 Tiling zoom level 3 for whole-rat_image
    2021-01-22 09:02:22,020 Tiling zoom level 2 for whole-rat_image
    2021-01-22 09:02:22,877 Tiling whole-rat_details_vagus_image...
    2021-01-22 09:02:22,941 Tiling zoom level 10 for whole-rat_details_vagus_image
    2021-01-22 09:02:23,283 Tiling zoom level 9 for whole-rat_details_vagus_image
    2021-01-22 09:02:23,359 Tiling zoom level 8 for whole-rat_details_vagus_image
    2021-01-22 09:02:23,395 Tiling zoom level 7 for whole-rat_details_vagus_image
    2021-01-22 09:02:23,535 Tiling whole-rat_details_tissue-slide_image...
    2021-01-22 09:02:23,660 Making image snapshot...
    2021-01-22 09:02:23,683 Tiling zoom level 10 for whole-rat_details_tissue-slide_image
    2021-01-22 09:02:23,790 Tiling zoom level 9 for whole-rat_details_tissue-slide_image
    2021-01-22 09:02:23,806 Tiling zoom level 8 for whole-rat_details_tissue-slide_image
    2021-01-22 09:02:23,811 Tiling zoom level 7 for whole-rat_details_tissue-slide_image
    2021-01-22 09:02:23,824 Creating index and style files...
    2021-01-22 09:02:24,052 Generated map: whole-rat for NCBITaxon:10114
